<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Books</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body class="bg-dashboard">
<div class="container mt-4 page-container">

<h3>Available Books</h3>
<div id="request-limit-message"
     class="alert alert-warning py-2 d-none"
     th:if="${role == 'STUDENT'}"
     th:attr="data-last-request-at=${lastRequestAt},data-can-request=${canRequest}">
    Only one book request is allowed within 24 hours.
</div>

<table class="table table-bordered mt-3">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Title</th>
            <th>Author</th>
            <th>ISBN</th>
            <th>Total</th>
            <th>Available</th>
            <th>Status</th>
            <th>Genre</th>

            <!-- ADMIN DELETE COLUMN -->
            <th th:if="${role == 'ADMIN'}">Action</th>

            <!-- STUDENT REQUEST COLUMN -->
            <th th:if="${role == 'STUDENT'}">Request</th>
        </tr>
    </thead>

    <tbody>
    <tr th:each="b : ${books}">
        <td th:text="${b.id}"></td>
        <td th:text="${b.title}"></td>
        <td th:text="${b.author}"></td>
        <td th:text="${b.isbn}"></td>
        <td th:text="${b.totalCopies}"></td>
        <td th:text="${b.availableCopies}"></td>
        <td>
            <span class="status-badge"
                  th:classappend="${b.availableCopies == 0} ? ' unavailable' : ''"
                  th:text="${b.availableCopies == 0 ? 'Unavailable' : 'Available'}">Available</span>
        </td>
        <td th:text="${b.genre}"></td>

        <!-- ADMIN DELETE -->
        <td th:if="${role == 'ADMIN'}">
            <form th:action="@{/books/delete/{id}(id=${b.id})}" method="post">
                <button class="btn btn-danger btn-sm"
                        onclick="return confirm('Delete this book?')">
                    Delete
                </button>
            </form>
        </td>

        <!-- STUDENT REQUEST / RETURN -->
        <td th:if="${role == 'STUDENT'}">
            <form action="/requests/create" method="post" class="mb-1">
                <input type="hidden" name="bookId" th:value="${b.id}">
                <button class="btn btn-success btn-sm w-100"
                        th:attr="data-unavailable=${b.availableCopies == 0}"
                        th:disabled="${b.availableCopies == 0}">
                    Request
                </button>
            </form>

            <form action="/transactions/return" method="post">
                <input type="hidden" name="bookId" th:value="${b.id}">
                <button class="btn btn-warning btn-sm w-100">
                    Return
                </button>
            </form>
        </td>
    </tr>
    </tbody>
</table>

<a href="/dashboard" class="btn btn-secondary mt-3">Back</a>

</div>
</body>
<script src="/js/book-requests.js"></script>
</html>
